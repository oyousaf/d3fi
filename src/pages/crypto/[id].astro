---
import Layout from "../../layouts/Layout.astro";
import { fetchCryptoData, fetchCryptoHistoricalData } from "../../utils/fetchCrypto";

export async function getStaticPaths() {
  const cryptos = await fetchCryptoData();
  return cryptos.map((crypto) => ({
    params: { id: crypto.id },
  }));
}

const { id } = Astro.params;
const historicalData = await fetchCryptoHistoricalData(id);

const labels = historicalData.prices.map(([timestamp]) => new Date(timestamp).toLocaleDateString());
const prices = historicalData.prices.map(([_, price]) => price);
---

<Layout>
  <h1 class="text-3xl font-extrabold text-center mb-6">Historical Data for {id.toUpperCase()}</h1>

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <canvas id="cryptoChart" class="w-full h-96"></canvas>
  </div>

  <a href="/" class="block text-center mt-4 text-teal-700 font-semibold">‚Üê Back to Cryptos</a>

  <script type="module">
    import Chart from "chart.js/auto";

    document.addEventListener("astro:after-swap", () => {
      const ctx = document.getElementById("cryptoChart")?.getContext("2d");
      if (!ctx) return;

      new Chart(ctx, {
        type: "line",
        data: {
          labels: JSON.parse({JSON.stringify(labels)}),
          datasets: [
            {
              label: "Price (GBP)",
              data: JSON.parse({JSON.stringify(prices)}),
              borderColor: "teal",
              borderWidth: 2,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    });
  </script>
</Layout>
